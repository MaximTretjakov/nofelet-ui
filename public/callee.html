<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nofelet</title>
    <link rel="stylesheet" href="./style.css">
</head>
<body>

<div id="startOverlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; display:flex; align-items:center; justify-content:center;">
    <button onclick="unlock()" style="padding:20px 40px; font-size:18px; border-radius:30px; cursor:pointer;">
        Войти в комнату звонков
    </button>
</div>

<main class="call-container">
    <div class="video-grid">
        <div class="video-wrapper">
            <div class="badge">
                <span class="user-icon">●</span>
                <span class="status">Собеседник</span>
                <span id="callerStatus" class=""></span>
            </div>
            <video id="remoteVideo" autoplay playsinline></video>
        </div>

        <div class="video-wrapper">
            <div class="badge">
                <span class="user-icon">○</span>
                <span class="status">Вы</span>
                <span id="calleeStatus" class=""></span>
            </div>
            <video id="localVideo" autoplay playsinline muted></video>
        </div>
    </div>

    <!-- Круглые кнопки в стиле Google Meet -->
    <nav class="controls">
        <button onclick="acceptCall()" class="btn-round btn-start" id="acceptCallBtn" title="Начать">Start</button>
        <button onclick="soundOff()" class="btn-round btn-toggle" id="soundToggle" title="Микрофон">Mic</button>
        <button onclick="videoOff()" class="btn-round btn-toggle" id="videoToggle" title="Камера">Cam</button>
        <button onclick="disconnect()" class="btn-round btn-end" id="hangUpBtn" title="Завершить">End</button>
    </nav>
</main>

<!-- WebRTC логика-->
<script>
    // СОЗДАЕМ ОБЪЕКТ ЗВУКА
    const ringtone = new Audio('./assets/call.mp3');
    ringtone.loop = true;   // Зацикливаем
    ringtone.volume = 0.5; // Громкость 50%

    // ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ
    let pc;
    let ws;
    let localStream = null;
    let remoteStream = null;
    let pendingOffer;
    let iceCandidatesQueue = [];
    let uuid = new URLSearchParams(window.location.search).get('uuid');

    // КОНФИГУРАЦИЯ С TURN СЕРВЕРАМИ
    const configuration = {
        iceTransportPolicy: 'relay',
        bundlePolicy: 'max-bundle',
        rtcpMuxPolicy: 'require'
    };

    function log(...a) { console.log('[CALLER]', ...a); }

    // ЗАПРОС ВРЕМЕННЫХ КРЕДОВ ДЛЯ TURN
    async function getTurn() {
        return new Promise((resolve, reject) => {
            const s = new WebSocket('wss://nofelet.duckdns.org:8443/turn-credentials/generate');
            s.onmessage = e => {
                resolve(JSON.parse(e.data).iceServers);
                s.close();
            };
            s.onerror = reject;
        });
    }

    // КОННЕКТ К СИГНАЛЬНОМУ СЕРВЕРУ
    async function connect() {
        ws = new WebSocket(`wss://nofelet.duckdns.org:8443/connect/${uuid}`);

        ws.onmessage = async e => {
            const msg = JSON.parse(e.data);

            if (msg.type === 'offer') {
                log('offer received');
                pendingOffer = msg;

                // ДОБАВЛЯЕМ АНИМАЦИЮ КНОПКЕ ЗВОНКА
                const btn = document.getElementById('acceptCallBtn');
                btn.disabled = false;
                btn.classList.add('ringing');

                // ВКЛЮЧАЕМ МЕЛОДИЮ ЗВОНКА
                ringtone.play().catch(err => console.error("Звук заблокирован:", err));

                // ВКЛЮЧАЕМ СТАТУС ОНЛАЙН ИНИЦИАТОРА
                const caller = document.getElementById('callerStatus');
                caller.classList.add('voice-indicator');
            }

            if (msg.type === 'ice-candidate') {
                if (pc?.remoteDescription) {
                    await pc.addIceCandidate(msg.candidate);
                } else {
                    iceCandidatesQueue.push(msg.candidate);
                }
            }
        };

        ws.onerror = async e => { log('ws error: ', e); };
    }


    // ПРИНИМАЕМ ВХОДЯЩИЙ ЗВОНОК
    async function acceptCall() {
        // УБИРАЕМ АНИМАЦИЮ С КНОПКИ START
        const btn = document.getElementById('acceptCallBtn');
        btn.classList.remove('ringing');

        // ВКЛЮЧАЕМ СТАТУС ОНЛАЙН
        const status = document.getElementById('calleeStatus');
        status.classList.add('voice-indicator');

        // ГЛУШИМ ЗВУК ВЫЗОВА
        ringtone.pause();
        ringtone.currentTime = 0; // Сброс в начало

        // ЛОЧИМ КНОПКУ ЗВОНКА
        document.getElementById('acceptCallBtn').disabled = true;

        // ЗАПРОС МЕДИА
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        document.getElementById('localVideo').srcObject = localStream;

        // ЗАПРОС ВРЕМЕННЫХ КРЕДОВ В TURN
        configuration.iceServers = await getTurn();

        // СОЗДАЕМ СОЕДИНЕНИЕ
        pc = new RTCPeerConnection(configuration);

        // ДОБАВЛЯЕМ ЛОКАЛЬНОЕ ВИДЕО
        localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

        // ДОБАВЛЯЕМ УДАЛЕННОЕ ВИДЕО
        pc.ontrack = e => document.getElementById('remoteVideo').srcObject = e.streams[0];

        // ОТСЫЛАЕМ КАНАДИДАТЫ
        pc.onicecandidate = e => {
            if (e.candidate) {
                ws.send(JSON.stringify({ type: 'ice-candidate', candidate: e.candidate }));
            }
        };

        // ЛОГИРУЕМ СОСТОЯНИЕ СОЕДИНЕНИЯ
        pc.onconnectionstatechange = () => {
            log('connectionState:', pc.connectionState);
            const state = pc.connectionState;
            if (state === 'connected') {
                log('connectionState:', 'connected');
            } else if (state === 'disconnected' || state === 'failed') {
                log('connectionState:', 'failed or disconnected');
                // ВЫКЛЮЧАЕМ СТАТУС ОНЛАЙН ИНИЦИАТОРА
                const caller = document.getElementById('callerStatus');
                caller.classList.remove('voice-indicator');
            } else if (state === 'connecting') {
                log('connectionState:', 'connecting...');
            }
        };

        // ПРИЕМ ОФЕРА ОТ ИНИЦИАТОРА
        await pc.setRemoteDescription({
            type: 'offer',
            sdp: pendingOffer.sdp
        });

        // ОБРАБОТКА КАНДИДАТОВ И ЧИСТКА ОЧЕРЕДИ КАНДИДАТОВ
        for (const c of iceCandidatesQueue) await pc.addIceCandidate(c);
        iceCandidatesQueue = [];

        // СОЗДАНИЕ АНСВЕРА
        const answer = await pc.createAnswer();

        // ОБНОВЛЯЕМ ЛОКАЛЬНЫЙ ДЕСКРИПШЕН АНСВЕРОМ
        await pc.setLocalDescription(answer);

        // ОТСЫЛАЕМ АНСВЕР ИНИЦИАТОРУ ЧЕРЕЗ СИГНАЛЬНЫЙ СЕРВЕР
        ws.send(JSON.stringify({ type: 'answer', sdp: answer.sdp }));
    }

    document.getElementById('acceptCallBtn').onclick = acceptCall;

    // ЗАВЕРШЕНИЕ ЗВОНКА
    function disconnect() {
        // ОСТАНАВЛИВАЕМ МЕЛОДИЮ ЕСЛИ ОНА ИГРАЕТ
        if (ringtone) {
            ringtone.pause();
            ringtone.currentTime = 0;
        }

        // ЗАКРЫВАЕМ WEBRTC СОЕДИНЕНИЕ
        if (pc) {
            pc.close();
            pc = null;
        }

        // ВЫКЛЮЧАЕМ ЛОКАЛЬНОЕ ВИДЕО
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
            localStream = null;
        }

        // ВЫКЛЮЧАЕМ УДАЛЕННОЕ ВИДЕО
        if (remoteStream) {
            remoteStream.getTracks().forEach(track => track.stop());
            remoteStream = null;
        }

        // ОПУСТОШАЕМ ОЧЕРЕДЬ КАНДИДАТОВ
        iceCandidatesQueue = [];
        document.getElementById('acceptCallBtn').disabled = true;
        document.getElementById('hangUpBtn').disabled = true;

        // ВЫКЛЮЧАЕМ СТАТУС ОНЛАЙН У СОБЕСЕДНИКА
        const callee = document.getElementById('calleeStatus');
        callee.classList.remove('voice-indicator');
        // ВЫКЛЮЧАЕМ СТАТУС ОНЛАЙН ИНИЦИАТОРА
        const caller = document.getElementById('callerStatus');
        caller.classList.remove('voice-indicator');

        // ЗАКРЫВАЕМ СОКЕТ ШТАТНО
        if (ws) {
            ws.close(1000, "Normal Closure");
            ws = null;
        }
    }

    // ПЕРЕКЛЮЧАТЕЛЬ СОСТОЯНИЯ КНОПОК ВИДЕО/АУДИО
    function toggleMedia(btn) {
        btn.classList.toggle('off');
    }

    // ОТКЛЮЧЕНИЕ/ВКЛЮЧЕНИЕ ВИДЕО ИНИЦИАТОРА
    function videoOff(){
        const camBtn = document.getElementById('videoToggle');

        toggleMedia(camBtn);

        const toggleButton = document.getElementById('videoToggle');

        const isVideoOn = toggleButton.classList.contains('off');
        if (isVideoOn){
            toggleButton.setAttribute('aria-label', 'Выключить видео');
            localStream.getVideoTracks().forEach(track => {
                track.enabled = false;
            });
        }else {
            localStream.getVideoTracks().forEach(track => {
                track.enabled = true;
            });
        }
    }

    // ОТКЛЮЧЕНИЕ/ВКЛЮЧЕНИЕ АУДИО ИНИЦИАТОРА
    function soundOff(){
        if (!localStream) return;

        // Проверяем текущее состояние первой аудиодорожки (если она есть)
        const audioTracks = localStream.getAudioTracks();
        if (audioTracks.length === 0) return;

        const currentState = audioTracks[0].enabled;
        const newState = !currentState;

        // Переключаем все аудиодорожки
        toggleAudio(localStream, newState);

        const micBtn = document.getElementById('soundToggle');
        toggleMedia(micBtn);
    }

    // ПЕРЕКЛЮЧАТЕЛЬ
    function toggleAudio(stream, enable) {
        if (!stream) return;

        // Получаем все аудиодорожки из потока
        const audioTracks = stream.getAudioTracks();

        // Проходим по всем найденным аудиодорожкам и устанавливаем им enabled
        audioTracks.forEach(track => {
            track.enabled = enable;
            console.log(`Аудиодорожка "${track.label}" теперь ${enable ? 'включена' : 'отключена'}.`);
        });
    }

    // УБИРАЕМ ОВЕРЛЕЙ
    function unlock() {
        // Убираем оверлей
        document.getElementById('startOverlay').style.display = 'none';

        // "Прогреваем" звук (важно вызвать .play() именно внутри этой функции-обработчика клика)
        ringtone.play().then(() => {
            ringtone.pause();
            ringtone.currentTime = 0;
        });

        console.log("Аудио разблокировано");
    }

    window.onload = connect;
</script>

</body>
</html>