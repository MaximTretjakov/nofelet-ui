<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nofelet</title>
    <link rel="stylesheet" href="./style.css">
</head>
<body>

<!-- Ссылка-приглашение -->
<div class="invite-container">
    <span class="invite-label">Ссылка для входа:</span>
    <code id="inviteLink" title="Нажмите, чтобы скопировать">Загрузка...</code>
</div>

<main class="call-container">
    <div class="video-grid">
        <div class="video-wrapper">
            <div class="badge">
                <span class="user-icon">●</span>
                <span class="status">Собеседник</span>
                <span id="calleeStatus" class=""></span>
            </div>
            <video id="remoteVideo" autoplay playsinline></video>
        </div>

        <div class="video-wrapper">
            <div class="badge">
                <span class="user-icon">○</span>
                <span class="status">Вы</span>
                <span id="callerStatus" class=""></span>
            </div>
            <video id="localVideo" autoplay playsinline muted></video>
        </div>
    </div>

    <!-- Круглые кнопки в стиле Google Meet -->
    <nav class="controls">
        <button onclick="startCall()" class="btn-round btn-start" id="startCallBtn" title="Начать">Start</button>
        <button onclick="soundOff()" class="btn-round btn-toggle" id="soundToggle" title="Микрофон">Mic</button>
        <button onclick="videoOff()" class="btn-round btn-toggle" id="videoToggle" title="Камера">Cam</button>
        <button onclick="disconnect()" class="btn-round btn-end" id="hangUpBtn" title="Завершить">End</button>
    </nav>
</main>

<!-- WebRTC логика-->
<script>
    // ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ
    let ws = null;
    let pc = null;
    let localStream = null;
    let remoteStream = null;
    let iceCandidatesQueue = [];
    let uuid = crypto.randomUUID();

    // КОНФИГУРАЦИЯ С TURN СЕРВЕРАМИ
    const configuration = {
        iceTransportPolicy: 'relay',
        bundlePolicy: 'max-bundle',
        rtcpMuxPolicy: 'require'
    };

    function log(...a) { console.log('[CALLER]', ...a); }

    // ГЕНЕРАЦИЯ ССЫЛКИ ПРИШЛАШЕНИЯ
    function inviteUrl() {
        document.getElementById('inviteLink').innerText = `${window.location.origin}/callee.html?uuid=${uuid}`;
    }

    // ЗАПРОС ВРЕМЕННЫХ КРЕДОВ ДЛЯ TURN
    async function getTurn() {
        return new Promise((resolve, reject) => {
            const s = new WebSocket('wss://nofelet.duckdns.org:8443/turn-credentials/generate');
            s.onmessage = e => {
                resolve(JSON.parse(e.data).iceServers);
                s.close();
            };
            s.onerror = reject;
        });
    }

    // КОННЕКТ К СИГНАЛЬНОМУ СЕРВЕРУ
    async function connect() {
        inviteUrl();

        ws = new WebSocket(`wss://nofelet.duckdns.org:8443/connect/${uuid}`);

        ws.onmessage = async e => {
            const msg = JSON.parse(e.data);

            if (msg.type === 'answer') {
                log('answer received');
                await pc.setRemoteDescription(msg);
                for (const c of iceCandidatesQueue) await pc.addIceCandidate(c);
                iceCandidatesQueue = [];
                // ВКЛЮЧАЕМ СТАТУС ОНЛАЙН
                const status = document.getElementById('calleeStatus');
                status.classList.add('voice-indicator');
            }

            if (msg.type === 'ice-candidate') {
                if (pc?.remoteDescription) {
                    await pc.addIceCandidate(msg.candidate);
                } else {
                    iceCandidatesQueue.push(msg.candidate);
                }
            }
        };
    }

    // СТАРТ ЗВОНКА
    async function startCall() {
        // ЛОЧИМ КНОПКУ СТАРТА ЗВОНКА
        document.getElementById('startCallBtn').disabled = true;

        // ВКЛЮЧАЕМ СТАТУС ОНЛАЙН
        const status = document.getElementById('callerStatus');
        status.classList.add('voice-indicator');

        // ЗАПРОС МЕДИА
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        document.getElementById('localVideo').srcObject = localStream;

        // ЗАПРОС ВРЕМЕННЫХ КРЕДОВ В TURN
        configuration.iceServers = await getTurn();

        // СОЗДАЕМ СОЕДИНЕНИЕ
        pc = new RTCPeerConnection(configuration);

        // ДОБАВЛЯЕМ ЛОКАЛЬНОЕ ВИДЕО
        localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

        // ДОБАВЛЯЕМ УДАЛЕННОЕ ВИДЕО
        pc.ontrack = e => document.getElementById('remoteVideo').srcObject = e.streams[0];

        // ОТСЫЛАЕМ КАНАДИДАТЫ
        pc.onicecandidate = e => {
            if (e.candidate) {
                ws.send(JSON.stringify({ type: 'ice-candidate', candidate: e.candidate }));
            }
        };

        // ЛОГИРУЕМ СОСТОЯНИЕ СОЕДИНЕНИЯ
        pc.onconnectionstatechange = () => {
            log('connectionState:', pc.connectionState);
            const state = pc.connectionState;
            if (state === 'connected') {
                log('connectionState:', 'connected');
            } else if (state === 'disconnected' || state === 'failed') {
                log('connectionState:', 'failed or disconnected');
                // ВЫКЛЮЧАЕМ СТАТУС ОНЛАЙН У СОБЕСЕДНИКА
                const callee = document.getElementById('calleeStatus');
                callee.classList.remove('voice-indicator');
            } else if (state === 'connecting') {
                log('connectionState:', 'connecting...');
            }
        };

        // СОЗДАЕМ ОФЕР
        const offer = await pc.createOffer();

        // ОБНОВЛЯЕМ ЛОКАЛЬНЫЙ ДЕСКРИПШЕН ОФЕРОМ
        await pc.setLocalDescription(offer);

        // ОТСЫЛАЕМ ОФЕР ИНИЦИАТОРУ ЧЕРЕЗ СИГНАЛЬНЫЙ СЕРВЕР
        ws.send(JSON.stringify({ type: 'offer', sdp: offer.sdp }));
    }

    document.getElementById('startCallBtn').onclick = startCall;

    // ЗАВЕРШЕНИЕ ЗВОНКА
    function disconnect() {
        // ЗАКРЫВАЕМ WEBRTC СОЕДИНЕНИЕ
        if (pc) {
            pc.close();
            pc = null;
        }

        // ВЫКЛЮЧАЕМ ЛОКАЛЬНОЕ ВИДЕО
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
            localStream = null;
        }

        // ВЫКЛЮЧАЕМ УДАЛЕННОЕ ВИДЕО
        if (remoteStream) {
            remoteStream.getTracks().forEach(track => track.stop());
            remoteStream = null;
        }

        // ОПУСТОШАЕМ ОЧЕРЕДЬ КАНДИДАТОВ
        iceCandidatesQueue = [];
        document.getElementById('startCallBtn').disabled = true;
        document.getElementById('hangUpBtn').disabled = true;

        // ВЫКЛЮЧАЕМ СТАТУС ОНЛАЙН У СОБЕСЕДНИКА
        const callee = document.getElementById('calleeStatus');
        callee.classList.remove('voice-indicator');
        // ВЫКЛЮЧАЕМ СТАТУС ОНЛАЙН ИНИЦИАТОРА
        const caller = document.getElementById('callerStatus');
        caller.classList.remove('voice-indicator');

        // ЗАКРЫВАЕМ СОКЕТ ШТАТНО
        if (ws) {
            ws.close(1000, "Normal Closure");
            ws = null;
        }
    }

    // ПЕРЕКЛЮЧАТЕЛЬ СОСТОЯНИЯ КНОПОК ВИДЕО/АУДИО
    function toggleMedia(btn) {
        btn.classList.toggle('off');
    }

    // ОТКЛЮЧЕНИЕ/ВКЛЮЧЕНИЕ ВИДЕО ИНИЦИАТОРА
    function videoOff(){
        const camBtn = document.getElementById('videoToggle');

        toggleMedia(camBtn);

        const toggleButton = document.getElementById('videoToggle');

        const isVideoOn = toggleButton.classList.contains('off');
        if (isVideoOn){
            toggleButton.setAttribute('aria-label', 'Выключить видео');
            localStream.getVideoTracks().forEach(track => {
                track.enabled = false;
            });
        }else {
            localStream.getVideoTracks().forEach(track => {
                track.enabled = true;
            });
        }
    }

    // ОТКЛЮЧЕНИЕ/ВКЛЮЧЕНИЕ АУДИО ИНИЦИАТОРА
    function soundOff(){
        if (!localStream) return;

        // Проверяем текущее состояние первой аудиодорожки (если она есть)
        const audioTracks = localStream.getAudioTracks();
        if (audioTracks.length === 0) return;

        const currentState = audioTracks[0].enabled;
        const newState = !currentState;

        // Переключаем все аудиодорожки
        toggleAudio(localStream, newState);

        const micBtn = document.getElementById('soundToggle');
        toggleMedia(micBtn);
    }

    // ПЕРЕКЛЮЧАТЕЛЬ
    function toggleAudio(stream, enable) {
        if (!stream) return;

        // Получаем все аудиодорожки из потока
        const audioTracks = stream.getAudioTracks();

        // Проходим по всем найденным аудиодорожкам и устанавливаем им enabled
        audioTracks.forEach(track => {
            track.enabled = enable;
            console.log(`Аудиодорожка "${track.label}" теперь ${enable ? 'включена' : 'отключена'}.`);
        });
    }

    // КОПИРОВАНИЕ UUID ПО КЛИКУ
    const linkElement = document.getElementById('inviteLink');
    linkElement.textContent = 'Ссылка приглашение ->  ' + `${window.location.origin}/callee.html?uuid=${uuid}`;

    linkElement.addEventListener('click', () => {
        navigator.clipboard.writeText(linkElement.textContent);
        const originalText = linkElement.textContent;
        linkElement.textContent = "Скопировано!";
        linkElement.style.color = "#000";
        setTimeout(() => {
            linkElement.textContent = originalText;
            linkElement.style.color = "";
        }, 2000);
    });

    window.onload = connect;
</script>

</body>
</html>